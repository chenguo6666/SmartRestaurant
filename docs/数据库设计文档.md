# 智慧餐厅系统 - 数据库设计文档

## 1. 概述

本文档详细描述了智慧餐厅点餐系统的MySQL数据库设计，包括所有核心业务模块对应的数据表结构、字段定义、索引设计和表关系。

### 1.1 设计原则
- 遵循第三范式，减少数据冗余
- 合理使用外键约束，保证数据完整性
- 考虑查询性能，添加必要索引
- 字段命名规范，使用下划线命名法
- 合理设置字段长度和数据类型

### 1.2 核心模块映射
- 用户管理模块 → users 表
- 菜品管理模块 → categories, dishes 表
- 订单管理模块 → orders, order_items 表
- 支付模块 → payments 表
- 营销促销模块 → coupons, user_coupons 表
- 餐厅信息 → restaurant_info 表
- 评价反馈模块 → reviews, feedbacks 表

## 2. 数据表设计

### 2.1 用户管理相关表

#### 2.1.1 用户表 (users)
用于存储用户基本信息和微信授权信息

```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
    openid VARCHAR(100) UNIQUE NOT NULL COMMENT '微信openid，用户唯一标识',
    union_id VARCHAR(100) COMMENT '微信unionid',
    nickname VARCHAR(100) DEFAULT '微信用户' COMMENT '微信昵称',
    avatar_url VARCHAR(500) COMMENT '微信头像URL',
    phone VARCHAR(20) COMMENT '手机号',
    gender TINYINT DEFAULT 0 COMMENT '性别：0-未知，1-男，2-女',
    is_active BOOLEAN DEFAULT TRUE COMMENT '账号是否激活',
    is_admin BOOLEAN DEFAULT FALSE COMMENT '是否为管理员',
    last_login_time DATETIME COMMENT '最后登录时间',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '注册时间',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_openid (openid),
    INDEX idx_phone (phone),
    INDEX idx_created_time (created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

### 2.2 菜品管理相关表

#### 2.2.1 菜品分类表 (categories)
```sql
CREATE TABLE categories (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '分类ID',
    name VARCHAR(50) NOT NULL COMMENT '分类名称',
    description TEXT COMMENT '分类描述',
    image_url VARCHAR(500) COMMENT '分类图片URL',
    sort_order INT DEFAULT 0 COMMENT '排序权重，数值越大越靠前',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_sort_order (sort_order DESC),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='菜品分类表';
```

#### 2.2.2 菜品表 (dishes)
```sql
CREATE TABLE dishes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '菜品ID',
    category_id BIGINT NOT NULL COMMENT '所属分类ID',
    name VARCHAR(100) NOT NULL COMMENT '菜品名称',
    description TEXT COMMENT '菜品描述',
    price DECIMAL(10,2) NOT NULL COMMENT '价格，单位：元',
    original_price DECIMAL(10,2) COMMENT '原价，用于显示折扣',
    image_url VARCHAR(500) COMMENT '菜品主图URL',
    image_urls JSON COMMENT '菜品多图URLs，JSON数组格式',
    stock_quantity INT DEFAULT 0 COMMENT '库存数量，-1表示无限库存',
    sales_count INT DEFAULT 0 COMMENT '销售数量',
    is_recommended BOOLEAN DEFAULT FALSE COMMENT '是否推荐菜品',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否上架',
    sort_order INT DEFAULT 0 COMMENT '排序权重',
    tags VARCHAR(200) COMMENT '菜品标签，逗号分隔',
    nutritional_info JSON COMMENT '营养信息，JSON格式',
    spicy_level TINYINT DEFAULT 0 COMMENT '辣度等级：0-不辣，1-微辣，2-中辣，3-重辣',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE RESTRICT,
    INDEX idx_category_id (category_id),
    INDEX idx_is_active (is_active),
    INDEX idx_is_recommended (is_recommended),
    INDEX idx_price (price),
    INDEX idx_sales_count (sales_count DESC),
    INDEX idx_sort_order (sort_order DESC),
    FULLTEXT idx_name_description (name, description)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='菜品表';
```

### 2.3 订单管理相关表

#### 2.3.1 订单表 (orders)
```sql
CREATE TABLE orders (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '订单ID',
    order_no VARCHAR(32) UNIQUE NOT NULL COMMENT '订单号，唯一标识',
    user_id BIGINT NOT NULL COMMENT '下单用户ID',
    total_amount DECIMAL(10,2) NOT NULL COMMENT '订单总金额',
    discount_amount DECIMAL(10,2) DEFAULT 0.00 COMMENT '优惠金额',
    final_amount DECIMAL(10,2) NOT NULL COMMENT '实付金额',
    status ENUM('pending_payment', 'paid', 'preparing', 'ready', 'completed', 'cancelled') 
           DEFAULT 'pending_payment' COMMENT '订单状态',
    payment_status ENUM('unpaid', 'paid', 'refunded', 'partial_refunded') 
                  DEFAULT 'unpaid' COMMENT '支付状态',
    table_number VARCHAR(20) COMMENT '桌号',
    customer_notes TEXT COMMENT '顾客备注',
    admin_notes TEXT COMMENT '管理员备注',
    estimated_time INT COMMENT '预估完成时间（分钟）',
    coupon_id BIGINT COMMENT '使用的优惠券ID',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '下单时间',
    paid_time DATETIME COMMENT '支付时间',
    completed_time DATETIME COMMENT '完成时间',
    cancelled_time DATETIME COMMENT '取消时间',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE RESTRICT,
    FOREIGN KEY (coupon_id) REFERENCES coupons(id) ON DELETE SET NULL,
    INDEX idx_order_no (order_no),
    INDEX idx_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_payment_status (payment_status),
    INDEX idx_created_time (created_time DESC),
    INDEX idx_table_number (table_number)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单表';
```

#### 2.3.2 订单项表 (order_items)
```sql
CREATE TABLE order_items (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '订单项ID',
    order_id BIGINT NOT NULL COMMENT '订单ID',
    dish_id BIGINT NOT NULL COMMENT '菜品ID',
    dish_name VARCHAR(100) NOT NULL COMMENT '菜品名称（快照）',
    dish_price DECIMAL(10,2) NOT NULL COMMENT '菜品单价（快照）',
    quantity INT NOT NULL COMMENT '购买数量',
    subtotal DECIMAL(10,2) NOT NULL COMMENT '小计金额',
    dish_image_url VARCHAR(500) COMMENT '菜品图片（快照）',
    special_requests TEXT COMMENT '特殊要求',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
    FOREIGN KEY (dish_id) REFERENCES dishes(id) ON DELETE RESTRICT,
    INDEX idx_order_id (order_id),
    INDEX idx_dish_id (dish_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单项表';
```

### 2.4 支付相关表

#### 2.4.1 支付记录表 (payments)
```sql
CREATE TABLE payments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '支付记录ID',
    order_id BIGINT NOT NULL COMMENT '订单ID',
    payment_no VARCHAR(64) UNIQUE NOT NULL COMMENT '支付流水号',
    payment_method ENUM('wechat_pay', 'alipay', 'cash') NOT NULL COMMENT '支付方式',
    amount DECIMAL(10,2) NOT NULL COMMENT '支付金额',
    status ENUM('pending', 'success', 'failed', 'cancelled', 'refunded') 
           DEFAULT 'pending' COMMENT '支付状态',
    third_party_transaction_id VARCHAR(100) COMMENT '第三方交易号',
    prepay_id VARCHAR(100) COMMENT '预支付交易会话标识',
    notify_data JSON COMMENT '支付回调通知数据',
    refund_amount DECIMAL(10,2) DEFAULT 0.00 COMMENT '退款金额',
    refund_reason VARCHAR(200) COMMENT '退款原因',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    paid_time DATETIME COMMENT '支付完成时间',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE RESTRICT,
    INDEX idx_order_id (order_id),
    INDEX idx_payment_no (payment_no),
    INDEX idx_third_party_transaction_id (third_party_transaction_id),
    INDEX idx_status (status),
    INDEX idx_created_time (created_time DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='支付记录表';
```

### 2.5 营销促销相关表

#### 2.5.1 优惠券表 (coupons)
```sql
CREATE TABLE coupons (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '优惠券ID',
    name VARCHAR(100) NOT NULL COMMENT '优惠券名称',
    code VARCHAR(50) UNIQUE NOT NULL COMMENT '优惠券代码',
    type ENUM('fixed_amount', 'percentage', 'free_shipping') NOT NULL COMMENT '优惠券类型',
    discount_value DECIMAL(10,2) NOT NULL COMMENT '优惠值：固定金额或百分比',
    min_order_amount DECIMAL(10,2) DEFAULT 0.00 COMMENT '最小订单金额',
    max_discount_amount DECIMAL(10,2) COMMENT '最大优惠金额（百分比券）',
    total_quantity INT NOT NULL COMMENT '发放总数量',
    used_quantity INT DEFAULT 0 COMMENT '已使用数量',
    per_user_limit INT DEFAULT 1 COMMENT '每用户限用次数',
    start_time DATETIME NOT NULL COMMENT '有效期开始时间',
    end_time DATETIME NOT NULL COMMENT '有效期结束时间',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    description TEXT COMMENT '使用说明',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_code (code),
    INDEX idx_type (type),
    INDEX idx_is_active (is_active),
    INDEX idx_start_end_time (start_time, end_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='优惠券表';
```

#### 2.5.2 用户优惠券关联表 (user_coupons)
```sql
CREATE TABLE user_coupons (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    coupon_id BIGINT NOT NULL COMMENT '优惠券ID',
    order_id BIGINT COMMENT '使用的订单ID',
    status ENUM('unused', 'used', 'expired') DEFAULT 'unused' COMMENT '使用状态',
    received_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '领取时间',
    used_time DATETIME COMMENT '使用时间',
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (coupon_id) REFERENCES coupons(id) ON DELETE CASCADE,
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE SET NULL,
    UNIQUE KEY uk_user_coupon (user_id, coupon_id),
    INDEX idx_user_id (user_id),
    INDEX idx_coupon_id (coupon_id),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户优惠券关联表';
```

### 2.6 餐厅信息相关表

#### 2.6.1 餐厅信息表 (restaurant_info)
```sql
CREATE TABLE restaurant_info (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    name VARCHAR(100) NOT NULL COMMENT '餐厅名称',
    description TEXT COMMENT '餐厅描述',
    phone VARCHAR(20) COMMENT '联系电话',
    address VARCHAR(200) COMMENT '餐厅地址',
    business_hours JSON COMMENT '营业时间，JSON格式存储每天的营业时间',
    logo_url VARCHAR(500) COMMENT '餐厅LOGO',
    background_images JSON COMMENT '背景图片URLs',
    announcement TEXT COMMENT '餐厅公告',
    service_charge_rate DECIMAL(5,2) DEFAULT 0.00 COMMENT '服务费率（百分比）',
    is_open BOOLEAN DEFAULT TRUE COMMENT '是否营业中',
    min_order_amount DECIMAL(10,2) DEFAULT 0.00 COMMENT '起送金额',
    table_count INT DEFAULT 0 COMMENT '餐桌数量',
    avg_meal_time INT DEFAULT 60 COMMENT '平均用餐时间（分钟）',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='餐厅信息表';
```

### 2.7 评价反馈相关表

#### 2.7.1 评价表 (reviews)
用于存储用户对菜品或订单的评价信息，所有人可见

```sql
CREATE TABLE reviews (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '评价ID',
    user_id BIGINT NOT NULL COMMENT '评价用户ID',
    order_id BIGINT COMMENT '关联订单ID',
    dish_id BIGINT COMMENT '关联菜品ID',
    rating TINYINT NOT NULL COMMENT '评分：1-5星',
    content TEXT COMMENT '评价内容',
    images JSON COMMENT '评价图片URLs，JSON数组格式',
    is_anonymous BOOLEAN DEFAULT FALSE COMMENT '是否匿名评价',
    reply_content TEXT COMMENT '商家回复内容',
    reply_time DATETIME COMMENT '回复时间',
    is_visible BOOLEAN DEFAULT TRUE COMMENT '是否显示（管理员可隐藏不当评价）',
    helpful_count INT DEFAULT 0 COMMENT '有用数量',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '评价时间',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
    FOREIGN KEY (dish_id) REFERENCES dishes(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_order_id (order_id),
    INDEX idx_dish_id (dish_id),
    INDEX idx_rating (rating),
    INDEX idx_is_visible (is_visible),
    INDEX idx_created_time (created_time DESC),
    CHECK (rating >= 1 AND rating <= 5),
    CHECK (order_id IS NOT NULL OR dish_id IS NOT NULL)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='评价表';
```

#### 2.7.2 用户反馈表 (feedbacks)
用于存储用户对系统或服务的反馈，仅管理员可见

```sql
CREATE TABLE feedbacks (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '反馈ID',
    user_id BIGINT NOT NULL COMMENT '反馈用户ID',
    type ENUM('suggestion', 'complaint', 'bug_report', 'feature_request', 'other') 
         NOT NULL DEFAULT 'suggestion' COMMENT '反馈类型',
    title VARCHAR(200) NOT NULL COMMENT '反馈标题',
    content TEXT NOT NULL COMMENT '反馈内容',
    contact_info VARCHAR(100) COMMENT '联系方式（手机号或微信）',
    images JSON COMMENT '反馈图片URLs，JSON数组格式',
    status ENUM('pending', 'processing', 'completed', 'closed') 
           DEFAULT 'pending' COMMENT '处理状态',
    priority ENUM('low', 'medium', 'high', 'urgent') 
             DEFAULT 'medium' COMMENT '优先级',
    admin_reply TEXT COMMENT '管理员回复',
    admin_id BIGINT COMMENT '处理的管理员ID',
    reply_time DATETIME COMMENT '回复时间',
    tags VARCHAR(200) COMMENT '标签，逗号分隔',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '反馈时间',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (admin_id) REFERENCES users(id) ON DELETE SET NULL,
    INDEX idx_user_id (user_id),
    INDEX idx_type (type),
    INDEX idx_status (status),
    INDEX idx_priority (priority),
    INDEX idx_admin_id (admin_id),
    INDEX idx_created_time (created_time DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户反馈表';
```

### 2.8 系统配置相关表

#### 2.8.1 系统配置表 (system_configs)
```sql
CREATE TABLE system_configs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '配置ID',
    config_key VARCHAR(100) UNIQUE NOT NULL COMMENT '配置键',
    config_value TEXT COMMENT '配置值',
    description VARCHAR(200) COMMENT '配置描述',
    data_type ENUM('string', 'number', 'boolean', 'json') DEFAULT 'string' COMMENT '数据类型',
    is_public BOOLEAN DEFAULT FALSE COMMENT '是否为公开配置（前端可访问）',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_config_key (config_key),
    INDEX idx_is_public (is_public)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统配置表';
```

## 3. 表关系说明

### 3.1 核心关系
- `users` 1:N `orders` (一个用户可以有多个订单)
- `orders` 1:N `order_items` (一个订单包含多个订单项)
- `orders` 1:N `payments` (一个订单可能有多次支付记录)
- `categories` 1:N `dishes` (一个分类包含多个菜品)
- `dishes` 1:N `order_items` (一个菜品可以在多个订单中)
- `coupons` N:M `users` (通过user_coupons关联)
- `users` 1:N `reviews` (一个用户可以有多个评价)
- `orders` 1:N `reviews` (一个订单可以有多个评价)
- `dishes` 1:N `reviews` (一个菜品可以有多个评价)
- `users` 1:N `feedbacks` (一个用户可以提交多个反馈)

### 3.2 关键约束
- 订单号(order_no)全局唯一
- 支付流水号(payment_no)全局唯一  
- 微信openid唯一标识用户
- 优惠券代码(code)全局唯一
- 用户-优惠券组合唯一

## 4. 索引设计说明

### 4.1 主要查询场景及对应索引
- 按分类查询菜品 → `idx_category_id`
- 订单列表查询 → `idx_user_id`, `idx_status`, `idx_created_time`
- 菜品搜索 → `FULLTEXT idx_name_description`
- 支付状态查询 → `idx_payment_status`, `idx_status`
- 优惠券验证 → `idx_code`, `idx_start_end_time`
- 评价列表查询 → `idx_dish_id`, `idx_order_id`, `idx_rating`
- 反馈管理查询 → `idx_status`, `idx_type`, `idx_priority`

### 4.2 性能优化建议
- 订单表按时间分区存储历史数据
- 菜品销量字段定期更新，避免实时计算
- 用户活跃度相关字段适当冗余
- 考虑将热点菜品信息缓存到Redis

## 5. 数据完整性约束

### 5.1 业务规则约束
- 订单金额必须大于0
- 菜品价格必须大于0
- 库存数量不能为负数（除-1表示无限库存）
- 订单状态变更遵循业务流程
- 优惠券使用需验证有效期和使用条件

### 5.2 外键约束策略
- 用户删除：限制删除(RESTRICT)，保护订单数据
- 菜品删除：限制删除(RESTRICT)，保护订单历史
- 订单删除：级联删除订单项(CASCADE)
- 优惠券删除：用户优惠券设为NULL(SET NULL)

## 6. 初始化数据建议

### 6.1 基础数据
```sql
-- 插入默认餐厅信息
INSERT INTO restaurant_info (name, description, phone) 
VALUES ('智慧餐厅', '美味佳肴，智能体验', '400-123-4567');

-- 插入默认菜品分类
INSERT INTO categories (name, sort_order) VALUES 
('招牌菜', 100),
('热菜', 90),
('凉菜', 80),
('汤品', 70),
('主食', 60),
('饮品', 50);

-- 插入系统配置
INSERT INTO system_configs (config_key, config_value, description) VALUES 
('order_timeout_minutes', '30', '订单超时时间（分钟）'),
('max_table_number', '50', '最大桌号'),
('service_start_time', '09:00', '服务开始时间'),
('service_end_time', '22:00', '服务结束时间');
```

此数据库设计支撑智慧餐厅系统的所有核心功能，具有良好的扩展性和性能表现。 