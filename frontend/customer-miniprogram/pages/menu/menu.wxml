<!--menu.wxml-->
<view class="page-container">
  <!-- æœç´¢æ  -->
  <view class="search-bar">
    <view class="search-input-wrapper">
      <input 
        class="search-input" 
        placeholder="æœç´¢èœå“..." 
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
      />
    </view>
  </view>
  
  <!-- ä¸»ä½“å†…å®¹ -->
  <view class="container">
    <!-- åˆ†ç±»åˆ—è¡¨ -->
    <scroll-view class="category-list" scroll-y>
      <view 
        class="category-item {{selectedCategoryId === item.id ? 'active' : ''}}"
        wx:for="{{categories}}" 
        wx:key="id"
        data-id="{{item.id}}"
        bindtap="onCategorySelect"
      >
        {{item.name}}
      </view>
    </scroll-view>
    
    <!-- èœå“åˆ—è¡¨ -->
    <scroll-view class="dish-list" scroll-y bindscrolltolower="onLoadMore">
      <view class="dish-item card" wx:for="{{filteredDishes}}" wx:key="id">
        <image 
          class="dish-image" 
          src="{{item.image_url || '/images/default-dish.png'}}" 
          mode="aspectFill"
          bindtap="onDishTap"
          data-id="{{item.id}}"
        />
        
        <view class="dish-info">
          <view class="dish-name">{{item.name}}</view>
          <view class="dish-desc" wx:if="{{item.description}}">{{item.description}}</view>
          
          <!-- ä»·æ ¼ä¿¡æ¯ -->
          <view class="price-wrapper">
            <text class="dish-price price">Â¥{{item.price}}</text>
            <text class="original-price" wx:if="{{item.original_price}}">Â¥{{item.original_price}}</text>
          </view>
          
          <!-- è¾£åº¦æ ‡ç­¾ -->
          <view class="spicy-level" wx:if="{{item.spicy_level > 0}}">
            <text class="spicy-text">{{item.spicy_level_display}}</text>
          </view>
          
          <!-- æ¨èæ ‡ç­¾ -->
          <view class="recommend-tag" wx:if="{{item.is_recommended}}">
            <text class="recommend-text">æ¨è</text>
          </view>
        </view>
        
        <view class="dish-actions">
          <!-- è·å–å½“å‰èœå“åœ¨è´­ç‰©è½¦ä¸­çš„æ•°é‡ -->
          <view class="quantity-display" hidden="{{true}}">
            <wxs module="cartHelper">
              function getItemCount(cartItems, dishId) {
                for (var i = 0; i < cartItems.length; i++) {
                  if (cartItems[i].id === dishId) {
                    return cartItems[i].quantity;
                  }
                }
                return 0;
              }
              module.exports = { getItemCount: getItemCount };
            </wxs>
          </view>
          
          <!-- å·²æœ‰æ•°é‡æ—¶æ˜¾ç¤ºæ•°é‡æ§åˆ¶å™¨ -->
          <view class="quantity-control" wx:if="{{cartHelper.getItemCount(cartItems, item.id) > 0}}">
            <button 
              class="quantity-btn decrease-btn" 
              data-id="{{item.id}}"
              bindtap="onReduceCart"
            >-</button>
            <text class="quantity">{{cartHelper.getItemCount(cartItems, item.id)}}</text>
            <button 
              class="quantity-btn increase-btn" 
              data-id="{{item.id}}"
              bindtap="onIncreaseCart"
            >+</button>
          </view>
          
          <!-- æœªåŠ è´­æ—¶æ˜¾ç¤ºåŠ å·æŒ‰é’® -->
          <button 
            class="add-btn btn-primary" 
            wx:else
            data-dish="{{item}}"
            bindtap="onAddToCart"
            disabled="{{!item.is_in_stock}}"
          >{{item.is_in_stock ? '+' : 'å”®å®Œ'}}</button>
        </view>
      </view>
      
      <!-- åŠ è½½æ›´å¤šæç¤º -->
      <view class="load-more" wx:if="{{hasMore && !loading}}">
        <text class="text-muted">ä¸Šæ‹‰åŠ è½½æ›´å¤š...</text>
      </view>
      
      <!-- åŠ è½½ä¸­ -->
      <view class="loading-more" wx:if="{{loading}}">
        <text class="text-muted">åŠ è½½ä¸­...</text>
      </view>
      
      <!-- æ²¡æœ‰æ›´å¤šæ•°æ® -->
      <view class="no-more" wx:if="{{!hasMore && filteredDishes.length > 0 && !loading}}">
        <text class="text-muted">æ²¡æœ‰æ›´å¤šèœå“äº†</text>
      </view>
      
      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{filteredDishes.length === 0 && !loading}}">
        <image class="empty-image" src="/images/empty-dish.png" mode="aspectFit" />
        <text class="empty-text text-muted">{{searchKeyword ? 'æœªæ‰¾åˆ°ç›¸å…³èœå“' : 'æš‚æ— èœå“'}}</text>
      </view>
    </scroll-view>
  </view>
  
  <!-- è´­ç‰©è½¦æµ®åŠ¨æŒ‰é’® -->
  <view class="cart-float-btn" wx:if="{{cartItems.length > 0}}" bindtap="goToCart">
    <view class="cart-icon">ğŸ›’</view>
    <view class="cart-badge" wx:if="{{cartItems.length > 0}}">
      <wxs module="cartTotal">
        function getTotalCount(cartItems) {
          var total = 0;
          for (var i = 0; i < cartItems.length; i++) {
            total += cartItems[i].quantity;
          }
          return total;
        }
        
        function getTotalAmount(cartItems) {
          var total = 0;
          for (var i = 0; i < cartItems.length; i++) {
            total += cartItems[i].price * cartItems[i].quantity;
          }
          return total.toFixed(2);
        }
        
        module.exports = { 
          getTotalCount: getTotalCount,
          getTotalAmount: getTotalAmount 
        };
      </wxs>
      {{cartTotal.getTotalCount(cartItems)}}
    </view>
    <view class="cart-amount">Â¥{{cartTotal.getTotalAmount(cartItems)}}</view>
  </view>
</view>

<!-- åŠ è½½çŠ¶æ€ -->
<view class="loading-overlay" wx:if="{{loading}}">
  <view class="loading-content">
    <text>åŠ è½½ä¸­...</text>
  </view>
</view> 