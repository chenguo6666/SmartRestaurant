# 智慧餐厅系统 - 项目初始化与环境配置

## 1. 开发环境准备

### 1.1 Python环境配置
```bash
# 推荐使用Python 3.11+
python --version  # 确认版本 >= 3.11

我想把依赖安装在本地，就不创建虚拟环境了

### 1.2 核心依赖包安装
创建 `requirements.txt`：

```txt
# Django核心
Django==5.2
djangorestframework==3.14.0
django-cors-headers==4.3.1

# 数据库
mysqlclient==2.2.4
django-mysql==4.12.0

# 缓存
redis==5.0.1
django-redis==5.4.0

# 认证相关
PyJWT==2.8.0
cryptography==41.0.7

# 微信支付
WeChatPay==1.2.17
requests==2.31.0

# 图片处理
Pillow==10.1.0

# 环境变量管理
python-dotenv==1.0.0

# API文档
drf-spectacular==0.26.5

# 开发工具
django-debug-toolbar==4.2.0
django-extensions==3.2.3
```

安装依赖：
```bash
pip install -r requirements.txt
```

## 2. Django项目创建

### 2.1 创建Django项目
```bash
django-admin startproject smart_restaurant
cd smart_restaurant

# 创建apps目录
mkdir apps
touch apps/__init__.py

# 创建各个应用
cd apps
python ../manage.py startapp users
python ../manage.py startapp dishes  
python ../manage.py startapp orders
python ../manage.py startapp payments
python ../manage.py startapp coupons
python ../manage.py startapp reviews
python ../manage.py startapp restaurant
python ../manage.py startapp common
```

### 2.2 项目目录结构
```
smart_restaurant/
├── manage.py
├── requirements.txt
├── .env
├── smart_restaurant/
│   ├── __init__.py
│   ├── settings/
│   │   ├── __init__.py
│   │   ├── base.py
│   │   ├── development.py
│   │   ├── production.py
│   │   └── testing.py
│   ├── urls.py
│   └── wsgi.py
├── apps/
│   ├── __init__.py
│   ├── users/
│   ├── dishes/
│   ├── orders/
│   ├── payments/
│   ├── coupons/
│   ├── reviews/
│   ├── restaurant/
│   └── common/
├── static/
├── media/
├── logs/
└── docs/
```

### 2.3 配置文件重构
将settings.py重构为多环境配置：

**smart_restaurant/settings/base.py**：
```python
import os
from pathlib import Path
from dotenv import load_dotenv

# 加载环境变量
load_dotenv()

BASE_DIR = Path(__file__).resolve().parent.parent.parent

# 安全配置
SECRET_KEY = os.getenv('SECRET_KEY', 'your-secret-key-here')
DEBUG = False
ALLOWED_HOSTS = []

# 应用配置
DJANGO_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
]

THIRD_PARTY_APPS = [
    'rest_framework',
    'corsheaders',
    'drf_spectacular',
]

LOCAL_APPS = [
    'apps.users',
    'apps.dishes',
    'apps.orders',
    'apps.payments',
    'apps.coupons',
    'apps.reviews',
    'apps.restaurant',
    'apps.common',
]

INSTALLED_APPS = DJANGO_APPS + THIRD_PARTY_APPS + LOCAL_APPS

# 中间件配置
MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware',
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'smart_restaurant.urls'

# 模板配置
TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates'],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

# 数据库配置
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': os.getenv('DB_NAME', 'smart_restaurant'),
        'USER': os.getenv('DB_USER', 'root'),
        'PASSWORD': os.getenv('DB_PASSWORD', ''),
        'HOST': os.getenv('DB_HOST', 'localhost'),
        'PORT': os.getenv('DB_PORT', '3306'),
        'OPTIONS': {
            'charset': 'utf8mb4',
            'init_command': "SET sql_mode='STRICT_TRANS_TABLES'",
        }
    }
}

# Redis缓存配置
CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': f"redis://{os.getenv('REDIS_HOST', 'localhost')}:{os.getenv('REDIS_PORT', '6379')}/1",
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
        }
    }
}

# 国际化配置
LANGUAGE_CODE = 'zh-hans'
TIME_ZONE = 'Asia/Shanghai'
USE_I18N = True
USE_TZ = True

# 静态文件配置
STATIC_URL = '/static/'
STATIC_ROOT = BASE_DIR / 'staticfiles'
STATICFILES_DIRS = [
    BASE_DIR / 'static',
]

# 媒体文件配置
MEDIA_URL = '/media/'
MEDIA_ROOT = BASE_DIR / 'media'

# DRF配置
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'apps.common.authentication.JWTAuthentication',
    ],
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.IsAuthenticated',
    ],
    'DEFAULT_RENDERER_CLASSES': [
        'rest_framework.renderers.JSONRenderer',
    ],
    'DEFAULT_PAGINATION_CLASS': 'apps.common.pagination.StandardResultsSetPagination',
    'PAGE_SIZE': 20,
    'DEFAULT_SCHEMA_CLASS': 'drf_spectacular.openapi.AutoSchema',
}

# JWT配置
JWT_SECRET_KEY = os.getenv('JWT_SECRET_KEY', SECRET_KEY)
JWT_ALGORITHM = 'HS256'
JWT_EXP_DELTA_SECONDS = 7 * 24 * 60 * 60  # 7天

# 微信小程序配置
WECHAT_MINIPROGRAM = {
    'APP_ID': os.getenv('WECHAT_APP_ID'),
    'APP_SECRET': os.getenv('WECHAT_APP_SECRET'),
}

# 微信支付配置
WECHAT_PAY = {
    'MCHID': os.getenv('WECHAT_PAY_MCHID'),
    'PRIVATE_KEY_PATH': os.getenv('WECHAT_PAY_PRIVATE_KEY_PATH'),
    'CERT_SERIAL_NO': os.getenv('WECHAT_PAY_CERT_SERIAL_NO'),
    'APIV3_KEY': os.getenv('WECHAT_PAY_APIV3_KEY'),
    'NOTIFY_URL': os.getenv('WECHAT_PAY_NOTIFY_URL'),
}

# 日志配置
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {process:d} {thread:d} {message}',
            'style': '{',
        },
        'simple': {
            'format': '{levelname} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': BASE_DIR / 'logs' / 'django.log',
            'formatter': 'verbose',
        },
        'console': {
            'level': 'INFO',
            'class': 'logging.StreamHandler',
            'formatter': 'simple',
        },
    },
    'root': {
        'handlers': ['file', 'console'],
        'level': 'INFO',
    },
}

# 用户模型配置
AUTH_USER_MODEL = 'users.User'

# 默认主键字段类型
DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'
```

**smart_restaurant/settings/development.py**：
```python
from .base import *

DEBUG = True

ALLOWED_HOSTS = ['localhost', '127.0.0.1']

# 开发环境特定配置
INSTALLED_APPS += [
    'django_extensions',
    'debug_toolbar',
]

MIDDLEWARE += [
    'debug_toolbar.middleware.DebugToolbarMiddleware',
]

# CORS配置(开发环境)
CORS_ALLOW_ALL_ORIGINS = True

# Debug Toolbar配置
INTERNAL_IPS = [
    '127.0.0.1',
]
```

## 3. 环境变量配置

创建 `.env` 文件：
```env
# Django基础配置
SECRET_KEY=your-very-secret-key-here
DEBUG=True

# 数据库配置
DB_NAME=smart_restaurant
DB_USER=root
DB_PASSWORD=026634
DB_HOST=localhost
DB_PORT=3306

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379

# JWT配置
JWT_SECRET_KEY=your-jwt-secret-key

# 微信小程序配置
WECHAT_APP_ID=your-wechat-app-id
WECHAT_APP_SECRET=your-wechat-app-secret

# 微信支付配置
WECHAT_PAY_MCHID=your-merchant-id
WECHAT_PAY_PRIVATE_KEY_PATH=path/to/your/private/key.pem
WECHAT_PAY_CERT_SERIAL_NO=your-cert-serial-no
WECHAT_PAY_APIV3_KEY=your-apiv3-key
WECHAT_PAY_NOTIFY_URL=https://yourdomain.com/api/payments/wechat/notify/
```

## 4. 数据库初始化

### 4.1 连接测试
```python
# test_db_connection.py
import os
import django
from django.conf import settings

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'smart_restaurant.settings.development')
django.setup()

from django.db import connection

try:
    cursor = connection.cursor()
    cursor.execute("SELECT 1")
    print("数据库连接成功！")
except Exception as e:
    print(f"数据库连接失败: {e}")
```

### 4.2 创建日志目录
```bash
mkdir logs
touch logs/.gitkeep
```

## 5. Redis配置测试

```python
# test_redis_connection.py
import redis
from django.conf import settings

try:
    r = redis.Redis(host='localhost', port=6379, db=1)
    r.ping()
    print("Redis连接成功！")
except Exception as e:
    print(f"Redis连接失败: {e}")
```

## 6. 项目启动

### 6.1 初始化数据库
```bash
# 设置环境变量
export DJANGO_SETTINGS_MODULE=smart_restaurant.settings.development

# 创建迁移文件
python manage.py makemigrations

# 执行迁移
python manage.py migrate

# 创建超级用户
python manage.py createsuperuser
```

### 6.2 启动开发服务器
```bash
python manage.py runserver 0.0.0.0:8000
```

### 6.3 验证安装
访问以下URL验证安装：
- 管理后台：http://localhost:8000/admin/
- API根路径：http://localhost:8000/api/
- API文档：http://localhost:8000/api/schema/swagger-ui/

## 7. 开发工具配置

### 7.1 Git配置
创建 `.gitignore`：
```gitignore
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
env/
venv/
smart_restaurant_env/

# Django
*.log
local_settings.py
db.sqlite3
db.sqlite3-journal

# 媒体文件
media/

# 静态文件
staticfiles/

# 环境变量
.env
.env.local
.env.production

# IDE
.vscode/
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db
```

### 7.2 VS Code配置
创建 `.vscode/settings.json`：
```json
{
    "python.pythonPath": "./smart_restaurant_env/Scripts/python.exe",
    "python.linting.pylintEnabled": true,
    "python.linting.enabled": true,
    "python.formatting.provider": "black",
    "python.linting.flake8Enabled": true,
    "files.exclude": {
        "**/__pycache__": true,
        "**/*.pyc": true
    }
}
```

这样，项目的基础环境就配置完成了。接下来可以开始进行数据模型的设计和实现。 