# 智慧餐厅系统 - 安全与监控

## 1. 系统安全策略

### 1.1 认证安全
- JWT Token有效期控制
- Token黑名单机制
- 异常登录检测
- 微信登录安全验证

### 1.2 数据安全
- 敏感数据加密存储
- SQL注入防护
- XSS攻击防护
- CSRF攻击防护

### 1.3 API安全
- 接口频率限制
- 参数验证和过滤
- 权限控制
- 数据脱敏

## 2. Django安全配置

### 2.1 安全中间件配置
**smart_restaurant/settings/security.py**：
```python
import os
from .base import *

# 安全中间件
MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'corsheaders.middleware.CorsMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'apps.common.middleware.SecurityHeadersMiddleware',
    'apps.common.middleware.RateLimitMiddleware',
]

# 安全头设置
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True
SECURE_REFERRER_POLICY = 'strict-origin-when-cross-origin'
X_FRAME_OPTIONS = 'DENY'

# HTTPS设置
if not DEBUG:
    SECURE_SSL_REDIRECT = True
    SECURE_HSTS_SECONDS = 31536000  # 1年
    SECURE_HSTS_INCLUDE_SUBDOMAINS = True
    SECURE_HSTS_PRELOAD = True
    SESSION_COOKIE_SECURE = True
    CSRF_COOKIE_SECURE = True

# Cookie安全设置
SESSION_COOKIE_HTTPONLY = True
CSRF_COOKIE_HTTPONLY = True
SESSION_COOKIE_SAMESITE = 'Lax'
CSRF_COOKIE_SAMESITE = 'Lax'
SESSION_COOKIE_AGE = 86400  # 24小时

# 密码验证
AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
        'OPTIONS': {
            'min_length': 8,
        }
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]

# 文件上传安全
FILE_UPLOAD_MAX_MEMORY_SIZE = 5 * 1024 * 1024  # 5MB
DATA_UPLOAD_MAX_MEMORY_SIZE = 10 * 1024 * 1024  # 10MB
FILE_UPLOAD_PERMISSIONS = 0o644

# 允许的文件类型
ALLOWED_IMAGE_EXTENSIONS = ['.jpg', '.jpeg', '.png', '.gif', '.webp']
ALLOWED_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp']

# 数据库连接安全
DATABASES['default']['OPTIONS'].update({
    'sql_mode': 'STRICT_TRANS_TABLES',
    'charset': 'utf8mb4',
    'use_unicode': True,
    'init_command': """
        SET sql_mode='STRICT_TRANS_TABLES';
        SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
    """
})

# API速率限制
RATE_LIMIT_SETTINGS = {
    'DEFAULT': '1000/hour',
    'LOGIN': '10/minute',
    'PASSWORD_RESET': '5/minute',
    'API_CREATE': '100/hour',
    'API_UPDATE': '200/hour',
}
```

### 2.2 安全中间件实现
**apps/common/middleware.py（安全扩展）**：
```python
import time
import hashlib
from django.http import JsonResponse
from django.core.cache import cache
from django.utils.deprecation import MiddlewareMixin
from django.conf import settings
import logging

logger = logging.getLogger(__name__)

class SecurityHeadersMiddleware(MiddlewareMixin):
    """安全头中间件"""
    
    def process_response(self, request, response):
        # 安全头设置
        response['X-Content-Type-Options'] = 'nosniff'
        response['X-Frame-Options'] = 'DENY'
        response['X-XSS-Protection'] = '1; mode=block'
        response['Referrer-Policy'] = 'strict-origin-when-cross-origin'
        response['Permissions-Policy'] = 'geolocation=(), microphone=(), camera=()'
        
        # CSP头
        csp_policy = [
            "default-src 'self'",
            "script-src 'self' 'unsafe-inline'",
            "style-src 'self' 'unsafe-inline'",
            "img-src 'self' data: https:",
            "font-src 'self'",
            "connect-src 'self'",
            "frame-ancestors 'none'"
        ]
        response['Content-Security-Policy'] = '; '.join(csp_policy)
        
        return response

class RateLimitMiddleware(MiddlewareMixin):
    """API频率限制中间件"""
    
    def process_request(self, request):
        if not self.should_rate_limit(request):
            return None
        
        # 获取客户端标识
        client_id = self.get_client_id(request)
        
        # 获取限制规则
        rate_limit = self.get_rate_limit(request)
        if not rate_limit:
            return None
        
        # 检查频率限制
        if self.is_rate_limited(client_id, rate_limit):
            logger.warning(f"Rate limit exceeded for {client_id} on {request.path}")
            return JsonResponse({
                'code': 429,
                'message': '请求过于频繁，请稍后重试',
                'data': None
            }, status=429)
        
        return None
    
    def should_rate_limit(self, request):
        """判断是否需要频率限制"""
        # 跳过静态文件和管理员页面
        if request.path.startswith('/static/') or request.path.startswith('/admin/'):
            return False
        
        # 只限制API请求
        return request.path.startswith('/api/')
    
    def get_client_id(self, request):
        """获取客户端标识"""
        # 优先使用用户ID
        if hasattr(request, 'user') and request.user.is_authenticated:
            return f"user:{request.user.id}"
        
        # 使用IP地址
        ip = self.get_client_ip(request)
        return f"ip:{ip}"
    
    def get_client_ip(self, request):
        """获取客户端IP"""
        x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
        if x_forwarded_for:
            ip = x_forwarded_for.split(',')[0].strip()
        else:
            ip = request.META.get('REMOTE_ADDR')
        return ip
    
    def get_rate_limit(self, request):
        """获取频率限制规则"""
        path = request.path
        method = request.method
        
        # 特殊路径的限制
        if 'login' in path:
            return settings.RATE_LIMIT_SETTINGS.get('LOGIN', '10/minute')
        elif method == 'POST':
            return settings.RATE_LIMIT_SETTINGS.get('API_CREATE', '100/hour')
        elif method in ['PUT', 'PATCH']:
            return settings.RATE_LIMIT_SETTINGS.get('API_UPDATE', '200/hour')
        else:
            return settings.RATE_LIMIT_SETTINGS.get('DEFAULT', '1000/hour')
    
    def is_rate_limited(self, client_id, rate_limit):
        """检查是否超过频率限制"""
        try:
            limit, period = rate_limit.split('/')
            limit = int(limit)
            
            # 计算时间窗口
            if period == 'minute':
                window = 60
            elif period == 'hour':
                window = 3600
            elif period == 'day':
                window = 86400
            else:
                window = 3600  # 默认1小时
            
            # 生成缓存key
            current_window = int(time.time()) // window
            cache_key = f"rate_limit:{client_id}:{current_window}"
            
            # 获取当前计数
            current_count = cache.get(cache_key, 0)
            
            if current_count >= limit:
                return True
            
            # 增加计数
            cache.set(cache_key, current_count + 1, window)
            return False
            
        except (ValueError, AttributeError):
            return False

class AuditLogMiddleware(MiddlewareMixin):
    """审计日志中间件"""
    
    def process_request(self, request):
        request._audit_start_time = time.time()
    
    def process_response(self, request, response):
        # 记录审计日志
        if self.should_audit(request):
            self.log_request(request, response)
        
        return response
    
    def should_audit(self, request):
        """判断是否需要审计"""
        # 敏感操作需要审计
        sensitive_paths = [
            '/api/admin/',
            '/api/users/',
            '/api/orders/',
            '/api/payments/',
        ]
        
        return any(request.path.startswith(path) for path in sensitive_paths)
    
    def log_request(self, request, response):
        """记录请求日志"""
        duration = time.time() - getattr(request, '_audit_start_time', 0)
        
        audit_data = {
            'timestamp': time.time(),
            'user_id': getattr(request.user, 'id', None) if hasattr(request, 'user') else None,
            'ip_address': self.get_client_ip(request),
            'method': request.method,
            'path': request.path,
            'status_code': response.status_code,
            'duration': duration,
            'user_agent': request.META.get('HTTP_USER_AGENT', ''),
        }
        
        logger.info(f"AUDIT: {audit_data}")
    
    def get_client_ip(self, request):
        """获取客户端IP"""
        x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
        if x_forwarded_for:
            ip = x_forwarded_for.split(',')[0].strip()
        else:
            ip = request.META.get('REMOTE_ADDR')
        return ip
```

## 3. 数据加密和脱敏

### 3.1 敏感数据加密
**apps/common/encryption.py**：
```python
import base64
import hashlib
from cryptography.fernet import Fernet
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC
from django.conf import settings
import os

class DataEncryption:
    """数据加密类"""
    
    def __init__(self):
        self.key = self._get_or_create_key()
        self.cipher = Fernet(self.key)
    
    def _get_or_create_key(self):
        """获取或创建加密密钥"""
        key_file = os.path.join(settings.BASE_DIR, '.encryption_key')
        
        if os.path.exists(key_file):
            with open(key_file, 'rb') as f:
                return f.read()
        else:
            # 基于SECRET_KEY生成密钥
            password = settings.SECRET_KEY.encode()
            salt = b'smart_restaurant_salt'
            kdf = PBKDF2HMAC(
                algorithm=hashes.SHA256(),
                length=32,
                salt=salt,
                iterations=100000,
            )
            key = base64.urlsafe_b64encode(kdf.derive(password))
            
            # 保存密钥（生产环境应使用更安全的方式）
            with open(key_file, 'wb') as f:
                f.write(key)
            
            return key
    
    def encrypt(self, data):
        """加密数据"""
        if not data:
            return data
        
        if isinstance(data, str):
            data = data.encode('utf-8')
        
        encrypted = self.cipher.encrypt(data)
        return base64.urlsafe_b64encode(encrypted).decode('utf-8')
    
    def decrypt(self, encrypted_data):
        """解密数据"""
        if not encrypted_data:
            return encrypted_data
        
        try:
            encrypted_bytes = base64.urlsafe_b64decode(encrypted_data.encode('utf-8'))
            decrypted = self.cipher.decrypt(encrypted_bytes)
            return decrypted.decode('utf-8')
        except Exception:
            return encrypted_data  # 如果解密失败，返回原数据
    
    @staticmethod
    def hash_password(password, salt=None):
        """密码哈希"""
        if salt is None:
            salt = os.urandom(32)
        
        pwdhash = hashlib.pbkdf2_hmac('sha256',
                                     password.encode('utf-8'),
                                     salt,
                                     100000)
        return salt + pwdhash
    
    @staticmethod
    def verify_password(stored_password, provided_password):
        """验证密码"""
        salt = stored_password[:32]
        stored_hash = stored_password[32:]
        pwdhash = hashlib.pbkdf2_hmac('sha256',
                                     provided_password.encode('utf-8'),
                                     salt,
                                     100000)
        return pwdhash == stored_hash

# 全局加密实例
encryption = DataEncryption()

class EncryptedField:
    """加密字段"""
    
    def __init__(self, field_name):
        self.field_name = field_name
    
    def __get__(self, instance, owner):
        if instance is None:
            return self
        
        encrypted_value = getattr(instance, f'_{self.field_name}', None)
        if encrypted_value:
            return encryption.decrypt(encrypted_value)
        return None
    
    def __set__(self, instance, value):
        if value:
            encrypted_value = encryption.encrypt(value)
            setattr(instance, f'_{self.field_name}', encrypted_value)
        else:
            setattr(instance, f'_{self.field_name}', None)
```

### 3.2 数据脱敏
**apps/common/masking.py**：
```python
import re

class DataMasking:
    """数据脱敏类"""
    
    @staticmethod
    def mask_phone(phone):
        """手机号脱敏"""
        if not phone or len(phone) < 7:
            return phone
        
        return phone[:3] + '****' + phone[-4:]
    
    @staticmethod
    def mask_email(email):
        """邮箱脱敏"""
        if not email or '@' not in email:
            return email
        
        local, domain = email.split('@', 1)
        if len(local) <= 2:
            masked_local = local
        else:
            masked_local = local[0] + '*' * (len(local) - 2) + local[-1]
        
        return f"{masked_local}@{domain}"
    
    @staticmethod
    def mask_id_card(id_card):
        """身份证脱敏"""
        if not id_card or len(id_card) < 8:
            return id_card
        
        return id_card[:4] + '****' + id_card[-4:]
    
    @staticmethod
    def mask_bank_card(card_number):
        """银行卡号脱敏"""
        if not card_number or len(card_number) < 8:
            return card_number
        
        return card_number[:4] + ' **** **** ' + card_number[-4:]
    
    @staticmethod
    def mask_name(name):
        """姓名脱敏"""
        if not name:
            return name
        
        if len(name) <= 2:
            return name[0] + '*'
        else:
            return name[0] + '*' * (len(name) - 2) + name[-1]

# 序列化器中使用数据脱敏
class MaskedUserSerializer(serializers.ModelSerializer):
    """脱敏用户序列化器"""
    phone = serializers.SerializerMethodField()
    
    class Meta:
        model = User
        fields = ['id', 'nickname', 'phone', 'created_time']
    
    def get_phone(self, obj):
        return DataMasking.mask_phone(obj.phone)
```

## 4. 监控系统实现

### 4.1 性能监控
**apps/common/monitoring.py**：
```python
import time
import psutil
import logging
from django.db import connection
from django.core.cache import cache
from django.conf import settings

logger = logging.getLogger(__name__)

class PerformanceMonitor:
    """性能监控类"""
    
    @staticmethod
    def get_system_metrics():
        """获取系统指标"""
        return {
            'cpu_percent': psutil.cpu_percent(interval=1),
            'memory_percent': psutil.virtual_memory().percent,
            'disk_usage': psutil.disk_usage('/').percent,
            'load_average': psutil.getloadavg() if hasattr(psutil, 'getloadavg') else None,
        }
    
    @staticmethod
    def get_database_metrics():
        """获取数据库指标"""
        from django.db import connections
        
        metrics = {}
        for alias in connections:
            conn = connections[alias]
            with conn.cursor() as cursor:
                # 查询数量
                cursor.execute("SHOW STATUS LIKE 'Queries'")
                queries = cursor.fetchone()
                
                # 连接数
                cursor.execute("SHOW STATUS LIKE 'Threads_connected'")
                connections_count = cursor.fetchone()
                
                # 慢查询
                cursor.execute("SHOW STATUS LIKE 'Slow_queries'")
                slow_queries = cursor.fetchone()
                
                metrics[alias] = {
                    'queries': queries[1] if queries else 0,
                    'connections': connections_count[1] if connections_count else 0,
                    'slow_queries': slow_queries[1] if slow_queries else 0,
                }
        
        return metrics
    
    @staticmethod
    def get_cache_metrics():
        """获取缓存指标"""
        try:
            from django_redis import get_redis_connection
            redis_conn = get_redis_connection("default")
            
            info = redis_conn.info()
            return {
                'used_memory': info.get('used_memory', 0),
                'used_memory_human': info.get('used_memory_human', '0B'),
                'connected_clients': info.get('connected_clients', 0),
                'total_commands_processed': info.get('total_commands_processed', 0),
                'keyspace_hits': info.get('keyspace_hits', 0),
                'keyspace_misses': info.get('keyspace_misses', 0),
            }
        except Exception as e:
            logger.error(f"获取Redis指标失败: {e}")
            return {}
    
    @staticmethod
    def get_application_metrics():
        """获取应用指标"""
        from apps.users.models import User
        from apps.orders.models import Order
        from apps.dishes.models import Dish
        
        return {
            'total_users': User.objects.count(),
            'active_users': User.objects.filter(is_active=True).count(),
            'total_orders': Order.objects.count(),
            'pending_orders': Order.objects.filter(status='pending_payment').count(),
            'total_dishes': Dish.objects.count(),
            'active_dishes': Dish.objects.filter(is_active=True).count(),
        }

class RequestTracker:
    """请求跟踪器"""
    
    def __init__(self):
        self.requests = {}
    
    def start_request(self, request_id):
        """开始跟踪请求"""
        self.requests[request_id] = {
            'start_time': time.time(),
            'db_queries': len(connection.queries),
        }
    
    def end_request(self, request_id, response_size=0):
        """结束跟踪请求"""
        if request_id not in self.requests:
            return None
        
        start_data = self.requests.pop(request_id)
        end_time = time.time()
        
        return {
            'duration': end_time - start_data['start_time'],
            'db_queries': len(connection.queries) - start_data['db_queries'],
            'response_size': response_size,
        }

# 全局请求跟踪器
request_tracker = RequestTracker()

class MonitoringMiddleware:
    """监控中间件"""
    
    def __init__(self, get_response):
        self.get_response = get_response
    
    def __call__(self, request):
        # 生成请求ID
        request_id = id(request)
        request_tracker.start_request(request_id)
        
        response = self.get_response(request)
        
        # 记录请求指标
        metrics = request_tracker.end_request(
            request_id, 
            len(response.content) if hasattr(response, 'content') else 0
        )
        
        if metrics and metrics['duration'] > 1.0:  # 超过1秒的请求
            logger.warning(f"Slow request: {request.path} took {metrics['duration']:.2f}s")
        
        return response
```

### 4.2 日志配置
**apps/common/logging_config.py**：
```python
import os
import logging.config
from django.conf import settings

def setup_logging():
    """配置日志"""
    
    log_dir = os.path.join(settings.BASE_DIR, 'logs')
    os.makedirs(log_dir, exist_ok=True)
    
    LOGGING_CONFIG = {
        'version': 1,
        'disable_existing_loggers': False,
        'formatters': {
            'verbose': {
                'format': '[{levelname}] {asctime} {name} {module}.{funcName}:{lineno} - {message}',
                'style': '{',
            },
            'simple': {
                'format': '[{levelname}] {asctime} - {message}',
                'style': '{',
            },
            'json': {
                'format': '{"level": "{levelname}", "time": "{asctime}", "name": "{name}", "module": "{module}", "message": "{message}"}',
                'style': '{',
            },
        },
        'filters': {
            'require_debug_false': {
                '()': 'django.utils.log.RequireDebugFalse',
            },
            'require_debug_true': {
                '()': 'django.utils.log.RequireDebugTrue',
            },
        },
        'handlers': {
            'console': {
                'level': 'INFO',
                'filters': ['require_debug_true'],
                'class': 'logging.StreamHandler',
                'formatter': 'simple',
            },
            'file_info': {
                'level': 'INFO',
                'class': 'logging.handlers.RotatingFileHandler',
                'filename': os.path.join(log_dir, 'info.log'),
                'maxBytes': 1024 * 1024 * 15,  # 15MB
                'backupCount': 10,
                'formatter': 'verbose',
            },
            'file_error': {
                'level': 'ERROR',
                'class': 'logging.handlers.RotatingFileHandler',
                'filename': os.path.join(log_dir, 'error.log'),
                'maxBytes': 1024 * 1024 * 15,  # 15MB
                'backupCount': 10,
                'formatter': 'verbose',
            },
            'file_security': {
                'level': 'WARNING',
                'class': 'logging.handlers.RotatingFileHandler',
                'filename': os.path.join(log_dir, 'security.log'),
                'maxBytes': 1024 * 1024 * 15,  # 15MB
                'backupCount': 10,
                'formatter': 'json',
            },
            'file_audit': {
                'level': 'INFO',
                'class': 'logging.handlers.RotatingFileHandler',
                'filename': os.path.join(log_dir, 'audit.log'),
                'maxBytes': 1024 * 1024 * 15,  # 15MB
                'backupCount': 30,
                'formatter': 'json',
            },
        },
        'loggers': {
            'django': {
                'handlers': ['console', 'file_info', 'file_error'],
                'level': 'INFO',
                'propagate': False,
            },
            'django.security': {
                'handlers': ['file_security'],
                'level': 'WARNING',
                'propagate': False,
            },
            'smart_restaurant': {
                'handlers': ['console', 'file_info', 'file_error'],
                'level': 'INFO',
                'propagate': False,
            },
            'audit': {
                'handlers': ['file_audit'],
                'level': 'INFO',
                'propagate': False,
            },
            'security': {
                'handlers': ['file_security'],
                'level': 'WARNING',
                'propagate': False,
            },
        },
        'root': {
            'handlers': ['console', 'file_info', 'file_error'],
            'level': 'INFO',
        },
    }
    
    logging.config.dictConfig(LOGGING_CONFIG)
```

## 5. 监控API和仪表板

### 5.1 监控API实现
**apps/common/views.py**：
```python
from rest_framework.views import APIView
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import AllowAny
from apps.common.permissions import IsAdminUser
from apps.common.responses import APIResponse
from apps.common.monitoring import PerformanceMonitor
import logging

logger = logging.getLogger(__name__)

class HealthCheckView(APIView):
    """健康检查接口"""
    permission_classes = [AllowAny]
    
    def get(self, request):
        """健康检查"""
        try:
            # 检查数据库连接
            from django.db import connection
            with connection.cursor() as cursor:
                cursor.execute("SELECT 1")
            
            # 检查缓存连接
            from django.core.cache import cache
            cache.set('health_check', 'ok', 10)
            cache_status = cache.get('health_check') == 'ok'
            
            status = {
                'status': 'healthy',
                'database': 'ok',
                'cache': 'ok' if cache_status else 'error',
                'timestamp': time.time(),
            }
            
            return APIResponse.success(status)
            
        except Exception as e:
            logger.error(f"Health check failed: {e}")
            return APIResponse.error("Service unhealthy", status_code=503)

@api_view(['GET'])
@permission_classes([IsAdminUser])
def system_metrics(request):
    """系统指标接口"""
    try:
        metrics = {
            'system': PerformanceMonitor.get_system_metrics(),
            'database': PerformanceMonitor.get_database_metrics(),
            'cache': PerformanceMonitor.get_cache_metrics(),
            'application': PerformanceMonitor.get_application_metrics(),
        }
        
        return APIResponse.success(metrics)
    except Exception as e:
        logger.error(f"Failed to get system metrics: {e}")
        return APIResponse.error("Failed to get metrics")

@api_view(['GET'])
@permission_classes([IsAdminUser])
def security_alerts(request):
    """安全告警接口"""
    try:
        # 读取安全日志
        import json
        from datetime import datetime, timedelta
        
        alerts = []
        log_file = os.path.join(settings.BASE_DIR, 'logs', 'security.log')
        
        if os.path.exists(log_file):
            # 读取最近24小时的安全日志
            cutoff_time = datetime.now() - timedelta(hours=24)
            
            with open(log_file, 'r') as f:
                for line in f:
                    try:
                        log_entry = json.loads(line.strip())
                        log_time = datetime.fromisoformat(log_entry['time'])
                        
                        if log_time > cutoff_time:
                            alerts.append(log_entry)
                    except (json.JSONDecodeError, KeyError, ValueError):
                        continue
        
        return APIResponse.success({
            'alerts': alerts[-100:],  # 最近100条
            'total': len(alerts)
        })
    except Exception as e:
        logger.error(f"Failed to get security alerts: {e}")
        return APIResponse.error("Failed to get security alerts")
```

### 5.2 监控仪表板
**templates/admin/monitoring_dashboard.html**：
```html
<!DOCTYPE html>
<html>
<head>
    <title>智慧餐厅监控仪表板</title>
    <meta charset="utf-8">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .dashboard { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .card { border: 1px solid #ddd; padding: 20px; border-radius: 8px; }
        .metric { font-size: 24px; font-weight: bold; color: #333; }
        .metric.warning { color: #ff9800; }
        .metric.error { color: #f44336; }
        .chart-container { position: relative; height: 300px; }
    </style>
</head>
<body>
    <h1>智慧餐厅系统监控</h1>
    
    <div class="dashboard">
        <div class="card">
            <h3>系统资源</h3>
            <div>CPU使用率: <span id="cpu-usage" class="metric">--%</span></div>
            <div>内存使用率: <span id="memory-usage" class="metric">--%</span></div>
            <div>磁盘使用率: <span id="disk-usage" class="metric">--%</span></div>
        </div>
        
        <div class="card">
            <h3>应用指标</h3>
            <div>总用户数: <span id="total-users" class="metric">--</span></div>
            <div>活跃用户: <span id="active-users" class="metric">--</span></div>
            <div>待处理订单: <span id="pending-orders" class="metric">--</span></div>
        </div>
        
        <div class="card">
            <h3>数据库性能</h3>
            <div>连接数: <span id="db-connections" class="metric">--</span></div>
            <div>慢查询: <span id="slow-queries" class="metric">--</span></div>
        </div>
        
        <div class="card">
            <h3>缓存状态</h3>
            <div>内存使用: <span id="cache-memory" class="metric">--</span></div>
            <div>命中率: <span id="cache-hit-rate" class="metric">--%</span></div>
        </div>
        
        <div class="card">
            <h3>响应时间趋势</h3>
            <div class="chart-container">
                <canvas id="response-time-chart"></canvas>
            </div>
        </div>
        
        <div class="card">
            <h3>安全告警</h3>
            <div id="security-alerts">加载中...</div>
        </div>
    </div>

    <script>
        // 获取系统指标
        async function fetchMetrics() {
            try {
                const response = await fetch('/api/admin/system-metrics/', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateMetrics(data.data);
                }
            } catch (error) {
                console.error('Failed to fetch metrics:', error);
            }
        }
        
        // 更新指标显示
        function updateMetrics(metrics) {
            // 系统指标
            const system = metrics.system;
            updateElement('cpu-usage', `${system.cpu_percent}%`, system.cpu_percent > 80);
            updateElement('memory-usage', `${system.memory_percent}%`, system.memory_percent > 80);
            updateElement('disk-usage', `${system.disk_usage}%`, system.disk_usage > 90);
            
            // 应用指标
            const app = metrics.application;
            document.getElementById('total-users').textContent = app.total_users;
            document.getElementById('active-users').textContent = app.active_users;
            document.getElementById('pending-orders').textContent = app.pending_orders;
            
            // 数据库指标
            const db = metrics.database.default;
            if (db) {
                document.getElementById('db-connections').textContent = db.connections;
                updateElement('slow-queries', db.slow_queries, db.slow_queries > 10);
            }
            
            // 缓存指标
            const cache = metrics.cache;
            if (cache) {
                document.getElementById('cache-memory').textContent = cache.used_memory_human;
                
                const hitRate = cache.keyspace_hits / (cache.keyspace_hits + cache.keyspace_misses) * 100;
                updateElement('cache-hit-rate', `${hitRate.toFixed(1)}%`, hitRate < 80);
            }
        }
        
        function updateElement(id, value, isWarning = false) {
            const element = document.getElementById(id);
            element.textContent = value;
            element.className = isWarning ? 'metric warning' : 'metric';
        }
        
        // 获取安全告警
        async function fetchSecurityAlerts() {
            try {
                const response = await fetch('/api/admin/security-alerts/', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displaySecurityAlerts(data.data.alerts);
                }
            } catch (error) {
                console.error('Failed to fetch security alerts:', error);
            }
        }
        
        function displaySecurityAlerts(alerts) {
            const container = document.getElementById('security-alerts');
            
            if (alerts.length === 0) {
                container.innerHTML = '<div style="color: green;">无安全告警</div>';
                return;
            }
            
            const alertsHtml = alerts.slice(-5).map(alert => `
                <div style="border-left: 3px solid #f44336; padding: 8px; margin: 5px 0; background: #fff3f3;">
                    <strong>${alert.level}</strong> - ${alert.time}<br>
                    ${alert.message}
                </div>
            `).join('');
            
            container.innerHTML = alertsHtml;
        }
        
        // 初始化图表
        function initCharts() {
            const ctx = document.getElementById('response-time-chart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '平均响应时间(ms)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // 初始化和定时更新
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            fetchMetrics();
            fetchSecurityAlerts();
            
            // 每30秒更新一次
            setInterval(() => {
                fetchMetrics();
                fetchSecurityAlerts();
            }, 30000);
        });
    </script>
</body>
</html>
```

## 6. 告警系统

### 6.1 告警规则配置
**apps/common/alerts.py**：
```python
import logging
from datetime import datetime, timedelta
from django.core.mail import send_mail
from django.conf import settings
from apps.common.monitoring import PerformanceMonitor

logger = logging.getLogger(__name__)

class AlertManager:
    """告警管理器"""
    
    def __init__(self):
        self.alert_rules = {
            'high_cpu': {'threshold': 80, 'duration': 300},  # CPU超过80%持续5分钟
            'high_memory': {'threshold': 90, 'duration': 300},  # 内存超过90%持续5分钟
            'high_disk': {'threshold': 95, 'duration': 0},  # 磁盘超过95%立即告警
            'slow_response': {'threshold': 2.0, 'duration': 60},  # 响应时间超过2秒持续1分钟
            'high_error_rate': {'threshold': 5, 'duration': 300},  # 错误率超过5%持续5分钟
        }
        
        self.active_alerts = {}
    
    def check_system_alerts(self):
        """检查系统告警"""
        try:
            metrics = PerformanceMonitor.get_system_metrics()
            
            # 检查CPU使用率
            if metrics['cpu_percent'] > self.alert_rules['high_cpu']['threshold']:
                self.trigger_alert('high_cpu', f"CPU使用率过高: {metrics['cpu_percent']}%")
            
            # 检查内存使用率
            if metrics['memory_percent'] > self.alert_rules['high_memory']['threshold']:
                self.trigger_alert('high_memory', f"内存使用率过高: {metrics['memory_percent']}%")
            
            # 检查磁盘使用率
            if metrics['disk_usage'] > self.alert_rules['high_disk']['threshold']:
                self.trigger_alert('high_disk', f"磁盘使用率过高: {metrics['disk_usage']}%")
            
        except Exception as e:
            logger.error(f"检查系统告警失败: {e}")
    
    def trigger_alert(self, alert_type, message):
        """触发告警"""
        now = datetime.now()
        rule = self.alert_rules.get(alert_type, {})
        duration = rule.get('duration', 0)
        
        # 检查是否已经有活跃的告警
        if alert_type in self.active_alerts:
            alert_start = self.active_alerts[alert_type]['start_time']
            if (now - alert_start).total_seconds() < duration:
                return  # 还未达到持续时间要求
        else:
            # 记录新告警
            self.active_alerts[alert_type] = {
                'start_time': now,
                'message': message,
                'sent': False
            }
            
            if duration == 0:  # 立即告警
                self.send_alert(alert_type, message)
                return
        
        # 检查是否达到持续时间
        alert_data = self.active_alerts[alert_type]
        if (now - alert_data['start_time']).total_seconds() >= duration and not alert_data['sent']:
            self.send_alert(alert_type, message)
            alert_data['sent'] = True
    
    def send_alert(self, alert_type, message):
        """发送告警"""
        try:
            # 记录告警日志
            alert_logger = logging.getLogger('security')
            alert_logger.warning(f"ALERT: {alert_type} - {message}")
            
            # 发送邮件告警（如果配置了）
            if hasattr(settings, 'ALERT_EMAIL_RECIPIENTS'):
                send_mail(
                    subject=f'智慧餐厅系统告警 - {alert_type}',
                    message=f'告警类型: {alert_type}\n告警信息: {message}\n时间: {datetime.now()}',
                    from_email=settings.DEFAULT_FROM_EMAIL,
                    recipient_list=settings.ALERT_EMAIL_RECIPIENTS,
                    fail_silently=True
                )
            
            # 可以添加其他告警方式：短信、钉钉、企业微信等
            
        except Exception as e:
            logger.error(f"发送告警失败: {e}")
    
    def clear_alert(self, alert_type):
        """清除告警"""
        if alert_type in self.active_alerts:
            del self.active_alerts[alert_type]
            
            alert_logger = logging.getLogger('security')
            alert_logger.info(f"ALERT_CLEARED: {alert_type}")

# 全局告警管理器
alert_manager = AlertManager()

# Celery定时任务
from celery import shared_task

@shared_task
def check_system_health():
    """系统健康检查任务"""
    alert_manager.check_system_alerts()
    return "System health check completed"
```

通过完善的安全配置和监控系统，确保智慧餐厅系统的安全稳定运行，及时发现和处理各种安全威胁和性能问题。 